from praatio import textgrid
import os
import re
import shutil
import glob

def sanitize_filename(name: str) -> str:
    name = re.sub(r'[<>:"/\\|?*]', '_', name)
    return name.strip().replace(" ", "_")

def textgrid_to_ultrastar(id, ARTIST, TITLE, YEAR, MP3, COVER, BPM, VOCALS, INSTRUMENTAL, GAP, LANGUAGE, MFA, cursor, conn):
    """
    Convertit un Long TextGrid MFA en fichier Ultrastar pr√™t √† chanter.
    Chaque mot devient une note (-) avec d√©but et fin en centi√®mes de seconde.
    """

    # üîπ OUVERTURE DU TEXTGRID (praatio)
    tg = textgrid.openTextgrid(
        MFA,
        includeEmptyIntervals=False
    )

    # üîπ r√©cup√©rer le tier des mots
    if "words" not in tg.tierNames:
        raise ValueError("Tier 'words' introuvable dans le TextGrid MFA")

    words_tier = tg.getTier("words")

    safe_artist = sanitize_filename(ARTIST)
    safe_title = sanitize_filename(TITLE)

    base = "/app/UltraStar"
    target = os.path.join(base, safe_artist, safe_title)
    os.makedirs(target, exist_ok=True)

    # Copier m√©dias
    for ext in ("*.mp3", "*.jpg"):
        for f in glob.glob(os.path.join(os.path.dirname(MP3), ext)):
            shutil.copy2(f, target)

    out = os.path.join(
        target,
        f"{safe_artist} - {safe_title}.txt"
    )

    # Exemple d'utilisation
    #textgrid_file = "output/song_Long.TextGrid"  # le TextGrid MFA
    #ultrastar_file = "output/song.txt"

    # Ultrastar attend g√©n√©ralement un fichier txt avec info de la chanson
    lines = []
    lines.append(f"#TITLE: {TITLE}")
    lines.append(f"#ARTIST: {ARTIST}")
    lines.append(f"#LANGUAGE: {LANGUAGE}")
    lines.append(f"#YEAR: {YEAR}")
    lines.append(f"#MP3: {safe_artist} - {safe_title}.mp3")
    lines.append(f"#COVER: {safe_artist} - {safe_title} [CO].jpg")  
    lines.append(f"#BACKGROUND: {safe_artist} - {safe_title} [BG].jpg")  
    lines.append(f"#EDITION: ")   
    lines.append(f"#GENRE: ") 
    lines.append("")

    # Supposons que le premier def textgrid_to_ultrastar(id, ARTIST, TITLE, YEAR, MP3, COVER, BPM, VOCALS, INSTRUMENTAL, GAP, LANGUAGE, MFA, cursor, conn):
    """
    Convertit un Long TextGrid MFA en fichier Ultrastar pr√™t √† chanter.
    Chaque mot devient une note (-) avec d√©but et fin en centi√®mes de seconde.
    """

    # üîπ OUVERTURE DU TEXTGRID (praatio)
    tg = textgrid.openTextgrid(
        MFA,
        includeEmptyIntervals=False
    )

    # üîπ r√©cup√©rer le tier des mots
    if "words" not in tg.tierNames:
        raise ValueError("Tier 'words' introuvable dans le TextGrid MFA")

    words_tier = tg.getTier("words")

    safe_artist = sanitize_filename(ARTIST)
    safe_title = sanitize_filename(TITLE)

    base = "/app/UltraStar"
    target = os.path.join(base, safe_artist, safe_title)
    os.makedirs(target, exist_ok=True)

    # Copier m√©dias
    for ext in ("*.mp3", "*.jpg"):
        for f in glob.glob(os.path.join(os.path.dirname(MP3), ext)):
            shutil.copy2(f, target)

    out = os.path.join(
        target,
        f"{safe_artist} - {safe_title}.txt"
    )

    # Exemple d'utilisation
    #textgrid_file = "output/song_Long.TextGrid"  # le TextGrid MFA
    #ultrastar_file = "output/song.txt"

    # Ultrastar attend g√©n√©ralement un fichier txt avec info de la chanson
    lines = []
    lines.append(f"#TITLE: {TITLE}")
    lines.append(f"#ARTIST: {ARTIST}")
    lines.append(f"#LANGUAGE: {LANGUAGE}")
    lines.append(f"#YEAR: {YEAR}")
    lines.append(f"#MP3: {safe_artist} - {safe_title}.mp3")
    lines.append(f"#COVER: {safe_artist} - {safe_title} [CO].jpg")  
    lines.append(f"#BACKGROUND: {safe_artist} - {safe_title} [BG].jpg")  
    lines.append(f"#EDITION: ")   
    lines.append(f"#GENRE: ") 
    lines.append("")

    # Supposons que le premier intervalle soit la couche des mots
    # MFA Long TextGrid a souvent une seule tier "words" ou "phone" par mot
    words_tier = tg.getTier("words")  # nom exact du tier MFA

    for start, end, word in words_tier.entries:
        word = word.strip()
        if not word:
            continue
        start_cs = int(start * 100)
        end_cs = int(end * 100)
        lines.append(f"- {start_cs} {end_cs} {word}")

    # √âcriture du fichier Ultrastar
    with open(out, "w", encoding="utf-8") as f:
        f.write("\n".join(lines))
    # print(f"Fichier Ultrastar cr√©√© : {out}")

    cursor.execute(
        "UPDATE song_list SET Export_Ultrastar='Y' WHERE id=?",
        (id,)
    )
    conn.commit()

    print("     üé∂ Export UltraStar termin√© (version officielle)")



def textgrid_to_ultrastar(
    id, ARTIST, TITLE, YEAR, MP3, COVER, BPM, VOCALS, INSTRUMENTAL, GAP, LANGUAGE,
    MFA, cursor, conn
):
    """
    Convertit un fichier Long TextGrid MFA en fichier Ultrastar pr√™t √† chanter.
    Chaque mot devient une note (:) avec d√©but et fin (-) en ms.
    """

    safe_artist = sanitize_filename(ARTIST)
    safe_title = sanitize_filename(TITLE)

    base = "/app/UltraStar"
    target = os.path.join(base, safe_artist, safe_title)
    os.makedirs(target, exist_ok=True)

    # Copier m√©dias (MP3 et JPG)
    for ext in ("*.mp3", "*.jpg"):
        for f in glob.glob(os.path.join(os.path.dirname(MP3), ext)):
            shutil.copy2(f, target)

    output_file = os.path.join(target, f"{safe_artist} - {safe_title}.txt")

    NOTE_DEFAULT = 4   # hauteur par d√©faut
    TICK_MS = 50       # 1 tick = 50 ms, ajustable

    # Lire le TextGrid
    intervals = []
    with open(MFA, "r", encoding="utf-8") as f:
        xmin = xmax = text = None
        for line in f:
            line = line.strip()
            if line.startswith("xmin ="):
                xmin = float(line.split("=")[1].strip())
            elif line.startswith("xmax ="):
                xmax = float(line.split("=")[1].strip())
            elif line.startswith("text ="):
                text = line.split("=",1)[1].strip().strip('"')
                if text:  # ignorer les silences
                    intervals.append((xmin, xmax, text))
                xmin = xmax = text = None  # reset

    # √âcriture du fichier Ultrastar
    with open(output_file, "w", encoding="utf-8") as f_out:
        f_out.write(f"#TITLE:{TITLE}\n")
        f_out.write(f"#ARTIST:{ARTIST}\n")
        f_out.write(f"#MP3:{safe_artist} - {safe_title}.mp3\n")
        f_out.write(f"#COVER:{safe_artist} - {safe_title}\n")
        f_out.write(f"#BACKGROUND:\n")
        f_out.write(f"#BPM:{BPM}\n")
        f_out.write(f"#GAP:{GAP}\n\n")

        for xmin, xmax, word in intervals:
            start_ms = int(xmin * 1000)
            end_ms = int(xmax * 1000)
            duration_ticks = max(1, (end_ms - start_ms) // TICK_MS)
            f_out.write(f": {start_ms} {duration_ticks} {NOTE_DEFAULT} {word}\n")
            f_out.write(f"- {end_ms}\n")

    # print(f"‚úÖ Conversion termin√©e ! Fichier Ultrastar g√©n√©r√© : {output_file}")

    # Mise √† jour base de donn√©es
    cursor.execute(
        "UPDATE song_list SET Export_Ultrastar='Y' WHERE id=?",
        (id,)
    )
    conn.commit()

    print("     üé∂ Export UltraStar termin√© (version TextGrid MFA)")


def old_textgrid_to_ultrastar(id, ARTIST, TITLE, YEAR, MP3, COVER, BPM, VOCALS, INSTRUMENTAL, GAP, LANGUAGE, MFA, cursor, conn):
    """
    Convertit un Long TextGrid MFA en fichier Ultrastar pr√™t √† chanter.
    Chaque mot devient une note (-) avec d√©but et fin en centi√®mes de seconde.
    """

    # üîπ OUVERTURE DU TEXTGRID (praatio)
    tg = textgrid.openTextgrid(
        MFA,
        includeEmptyIntervals=False
    )

    # üîπ r√©cup√©rer le tier des mots
    if "words" not in tg.tierNames:
        raise ValueError("Tier 'words' introuvable dans le TextGrid MFA")

    words_tier = tg.getTier("words")

    safe_artist = sanitize_filename(ARTIST)
    safe_title = sanitize_filename(TITLE)

    base = "/app/UltraStar"
    target = os.path.join(base, safe_artist, safe_title)
    os.makedirs(target, exist_ok=True)

    # Copier m√©dias
    for ext in ("*.mp3", "*.jpg"):
        for f in glob.glob(os.path.join(os.path.dirname(MP3), ext)):
            shutil.copy2(f, target)

    out = os.path.join(
        target,
        f"{safe_artist} - {safe_title}.txt"
    )

    # Exemple d'utilisation
    #textgrid_file = "output/song_Long.TextGrid"  # le TextGrid MFA
    #ultrastar_file = "output/song.txt"

    # Ultrastar attend g√©n√©ralement un fichier txt avec info de la chanson
    lines = []
    lines.append(f"#TITLE: {TITLE}")
    lines.append(f"#ARTIST: {ARTIST}")
    lines.append(f"#LANGUAGE: {LANGUAGE}")
    lines.append(f"#YEAR: {YEAR}")
    lines.append(f"#MP3: {safe_artist} - {safe_title}.mp3")
    lines.append(f"#COVER: {safe_artist} - {safe_title} [CO].jpg")  
    lines.append(f"#BACKGROUND: {safe_artist} - {safe_title} [BG].jpg")  
    lines.append(f"#EDITION: ")   
    lines.append(f"#GENRE: ") 
    lines.append("")

    # Supposons que le premier intervalle soit la couche des mots
    # MFA Long TextGrid a souvent une seule tier "words" ou "phone" par mot
    words_tier = tg.getTier("words")  # nom exact du tier MFA

    for start, end, word in words_tier.entries:
        word = word.strip()
        if not word:
            continue
        start_cs = int(start * 100)
        end_cs = int(end * 100)
        lines.append(f"- {start_cs} {end_cs} {word}")

    # √âcriture du fichier Ultrastar
    with open(out, "w", encoding="utf-8") as f:
        f.write("\n".join(lines))
    # print(f"Fichier Ultrastar cr√©√© : {out}")

    cursor.execute(
        "UPDATE song_list SET Export_Ultrastar='Y' WHERE id=?",
        (id,)
    )
    conn.commit()

    print("     üé∂ Export UltraStar termin√© (version officielle)")

